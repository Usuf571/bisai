# 🎯 BiSAI - ПОЛНАЯ СХЕМА ПРОЕКТА

## 📊 Визуальная архитектура

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ВЕwaldб-ПРИЛОЖЕНИЕ BiSAI                          │
│                   "ПЕРЕТЯГИВАНИЕ КАНАТА" - КОМАНДНАЯ ВИКТОРИНА              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          КЛИЕНТСКАЯ ЧАСТЬ (Frontend)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  HTML Templates (Представления)        JavaScript (Логика)                  │
│  ├─ login.php                          ├─ main.js                          │
│  ├─ register.php                       ├─ game.js                          │
│  ├─ index.php (главная)                ├─ tug-of-war.js (анимация каната) │
│  ├─ dashboard.php (личный кабинет)     └─ auth.js                          │
│  ├─ create_test.php                                                         │
│  ├─ edit_test.php                      CSS (Стили)                          │
│  ├─ play.php (игровой интерфейс)       ├─ main.css                        │
│  └─ views/                             ├─ game.css                        │
│     ├─ layout/ (header, footer, nav)   ├─ auth.css                        │
│     ├─ auth/                           └─ responsive.css                   │
│     ├─ tests/                                                               │
│     └─ game/                           Assets                              │
│                                         ├─ audio/ (фоновая музыка)         │
│                                         └─ images/ (иконки, картинки)      │
└─────────────────────────────────────────────────────────────────────────────┘

                            ↓↑ AJAX запросы ↓↑
                        (JSON, XML, FormData)

┌─────────────────────────────────────────────────────────────────────────────┐
│                         СЕРВЕРНАЯ ЧАСТЬ (Backend)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────┐                                               │
│  │  МАРШРУТИЗАТОР (api.php)  │                                               │
│  │  ├─ action=login         │                                               │
│  │  ├─ action=create_test   │                                               │
│  │  ├─ action=submit_answer │                                               │
│  │  └─ action=get_game_state│                                               │
│  └──────────────────────────┘                                               │
│            ↓                                                                 │
│  ┌─────────────────────────────────────────────────┐                        │
│  │         КОНТРОЛЛЕРЫ (Controllers)               │                        │
│  │  ┌──────────────────┐  ┌──────────────────┐    │                        │
│  │  │ AuthController   │  │ TestController   │    │                        │
│  │  ├─ login()         │  ├─ listTests()     │    │                        │
│  │  ├─ register()      │  ├─ createForm()    │    │                        │
│  │  ├─ logout()        │  ├─ store()         │    │                        │
│  │  └─ handleLogin()   │  ├─ editForm()      │    │                        │
│  │                     │  ├─ update()        │    │                        │
│  │  ┌──────────────────┐ │  ├─ delete()       │    │                        │
│  │  │ GameController   │ │  └─ publish()      │    │                        │
│  │  ├─ setup()         │ └──────────────────┘    │                        │
│  │  ├─ play()          │  ┌──────────────────┐    │                        │
│  │  ├─ startGame()     │  │ BaseController   │    │                        │
│  │  ├─ getCurrentQuestion() │ ├─ render()       │    │                        │
│  │  ├─ submitAnswer()  │  ├─ json()          │    │                        │
│  │  ├─ nextQuestion()  │  ├─ redirect()      │    │                        │
│  │  ├─ getResults()    │  └─ requireAuth()   │    │                        │
│  │  └─ getGameState()  │                     │    │                        │
│  │                     └──────────────────┘    │                        │
│  └─────────────────────────────────────────────────┘                        │
│            ↓                                                                 │
│  ┌─────────────────────────────────────────────────┐                        │
│  │         МОДЕЛИ (Models) - ORM Слой             │                        │
│  │  ┌──────────────┐  ┌──────────────┐            │                        │
│  │  │ User         │  │ Test         │            │                        │
│  │  ├─ find()      │  ├─ find()      │            │                        │
│  │  ├─ register()  │  ├─ getQuestions()          │                        │
│  │  ├─ verifyPass()│  ├─ publish()   │            │                        │
│  │  └─ getTests() │  └─ getCreator()             │                        │
│  │                                                │                        │
│  │  ┌──────────────────┐  ┌─────────────────┐    │                        │
│  │  │ GameSession      │  │ Question/Answer │    │                        │
│  │  ├─ createNew()     │  ├─ getAnswers()   │    │                        │
│  │  ├─ getPlayers()    │  ├─ addAnswer()    │    │                        │
│  │  ├─ start()         │  └─ getCorrect()   │    │                        │
│  │  ├─ finish()        │                     │    │                        │
│  │  ├─ getResults()    │  ┌─────────────────┐    │                        │
│  │  └─ addPlayer()     │  │ BaseModel       │    │                        │
│  │                     │  ├─ save()         │    │                        │
│  │                     │  ├─ delete()       │    │                        │
│  │                     │  └─ fill()         │    │                        │
│  │                     └─────────────────┘    │                        │
│  └─────────────────────────────────────────────────┘                        │
│            ↓                                                                 │
│  ┌─────────────────────────────────────────────────┐                        │
│  │    ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ И КЛАССЫ             │                        │
│  │  ├─ includes/Database.php (PDO Singleton)      │                        │
│  │  ├─ includes/autoload.php (автозагрузка)       │                        │
│  │  ├─ includes/functions.php (утилиты)           │                        │
│  │  └─ includes/auth.php (аутентификация)         │                        │
│  └─────────────────────────────────────────────────┘                        │
│            ↓                                                                 │
│  ┌─────────────────────────────────────────────────┐                        │
│  │           БАЗА ДАННЫХ (MySQL 5.7+)             │                        │
│  │                                                  │                        │
│  │  ┌──────────────────┐  ┌──────────────────┐    │                        │
│  │  │ bisai_users      │  │ bisai_tests      │    │                        │
│  │  ├─ id (PK)         │  ├─ id (PK)         │    │                        │
│  │  ├─ username        │  ├─ creator_id (FK)│    │                        │
│  │  ├─ email           │  ├─ title          │    │                        │
│  │  ├─ password_hash   │  ├─ description    │    │                        │
│  │  ├─ role            │  ├─ difficulty     │    │                        │
│  │  ├─ is_active       │  ├─ status         │    │                        │
│  │  └─ created_at      │  └─ is_public      │    │                        │
│  │                     │                     │    │                        │
│  │  ┌──────────────────┐  ┌──────────────────┐    │                        │
│  │  │ bisai_questions  │  │ bisai_answers    │    │                        │
│  │  ├─ id (PK)         │  ├─ id (PK)         │    │                        │
│  │  ├─ test_id (FK)    │  ├─ question_id(FK)│    │                        │
│  │  ├─ question_text   │  ├─ answer_text    │    │                        │
│  │  ├─ question_type   │  ├─ is_correct     │    │                        │
│  │  └─ order           │  └─ order          │    │                        │
│  │                     │                     │    │                        │
│  │  ┌───────────────────────────────────┐   │    │                        │
│  │  │ bisai_game_sessions               │   │    │                        │
│  │  ├─ id, test_id (FK), session_code   │   │    │                        │
│  │  ├─ status, team_red_name, team_...  │   │    │                        │
│  │  └─ current_question_index           │   │    │                        │
│  │                                       │   │    │                        │
│  │  ┌───────────────────────────────────┐   │    │                        │
│  │  │ bisai_game_players                │   │    │                        │
│  │  ├─ id, game_session_id (FK)         │   │    │                        │
│  │  ├─ player_name, team_color          │   │    │                        │
│  │  └─ score, correct_answers           │   │    │                        │
│  │                                       │   │    │                        │
│  │  ┌───────────────────────────────────┐   │    │                        │
│  │  │ bisai_player_answers              │   │    │                        │
│  │  ├─ game_session_id (FK), question_id│   │    │                        │
│  │  ├─ answer_id (FK), is_correct       │   │    │                        │
│  │  └─ response_time                    │   │    │                        │
│  │                                       │   │    │                        │
│  │  └─ + 2 таблицы для статистики и логов   │    │                        │
│  └─────────────────────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Жизненный цикл запроса

```
1. ИНИЦИИРОВАНИЕ ЗАПРОСА
   ┌─────────────────────────────────────┐
   │ Пользователь кликает на кнопку      │
   │ "Отправить ответ"                   │
   └────────────┬────────────────────────┘
                │
2. ОТПРАВКА ЗАПРОСА
   │
   └─→ fetch('/api.php?action=submit_answer', {
       method: 'POST',
       body: {
           session_code: 'ABC123',
           player_id: 5,
           answer_id: 12
       }
   })
                │
3. МАРШРУТИЗАЦИЯ
   │
   └─→ /public/api.php
       └─→ $action = 'submit_answer'
           └─→ new GameController()->submitAnswer()
                │
4. КОНТРОЛЛЕР
   │
   └─→ GameController::submitAnswer()
       ├─ Получить параметры ($_POST)
       ├─ Валидировать данные
       ├─ Создать объект Answer
       └─ Вызвать методы модели
                │
5. МОДЕЛЬ
   │
   └─→ Answer::fill(...)->attributes
       Question::getCorrectAnswer()->is_correct
       GamePlayer::addScore(1)
       └─→ Database::execute("UPDATE ...")
                │
6. БАЗА ДАННЫХ
   │
   └─→ UPDATE bisai_player_answers SET is_correct = 1
       UPDATE bisai_game_players SET score = score + 1
       ✅ УСПЕХ
                │
7. ОТВЕТ
   │
   └─→ json_encode([
       'success' => true,
       'is_correct' => true,
       'player_score' => 5
   ])
                │
8. ОБРАБОТКА ОТВЕТА
   │
   └─→ JavaScript получает JSON
       ├─ Анимировать правильный ответ
       ├─ Обновить канат (canvas)
       ├─ Обновить счет
       └─ Перейти к следующему вопросу
```

---

## 🎮 Жизненный цикл игры

```
ЭТАП 1: ВЫБОР ТЕСТА
├─ Пользователь видит список тестов на главной
├─ Выбирает интересующий тест
└─ Переходит на страницу подготовки к игре

ЭТАП 2: ПОДГОТОВКА
├─ Ввод названия красной команды
├─ Ввод названия синей команды
├─ Создание GameSession (GET /api.php?action=create_game_session)
└─ Редирект на страницу игры с кодом сессии

ЭТАП 3: ДОБАВЛЕНИЕ ИГРОКОВ
├─ Игрок вводит свое имя
├─ Выбирает цвет команды (красная или синяя)
├─ POST /api.php?action=add_player
└─ Игрок добавлен в GamePlayers

ЭТАП 4: НАЧАЛО ИГРЫ
├─ Когда все готовы, нажимается "Начать"
├─ POST /api.php?action=start_game
├─ Статус GameSession изменяется на "in_progress"
└─ Загружается первый вопрос

ЭТАП 5: ИГРОВОЙ ПРОЦЕСС
├─ GET /api.php?action=get_current_question
│  └─ Отображается вопрос с вариантами ответов
├─ Игрок выбирает ответ
├─ POST /api.php?action=submit_answer
│  ├─ Проверяется правильность ответа
│  ├─ Обновляется счет игрока
│  └─ Сохраняется в PlayerAnswers
├─ Canvas анимирует движение каната
├─ POST /api.php?action=next_question
├─ Повтор для каждого вопроса
└─ Когда вопросы закончились → перейти на этап 6

ЭТАП 6: ЗАВЕРШЕНИЕ
├─ POST /api.php?action=finish_game
├─ Расчет результатов
├─ Обновление статистики пользователей
├─ GET /api.php?action=get_results
└─ Отображение страницы результатов с победителем

ЭТАП 7: ИТОГИ
├─ Показать:
│  ├─ Имя и счет красной команды
│  ├─ Имя и счет синей команды
│  ├─ Имена и очки каждого игрока
│  └─ Золотой кубок для победившей команды
└─ Кнопка для возврата на главную
```

---

## 📊 Диаграмма базы данных (детальная)

```
USERS (Пользователи)
│
├─→ Может создать ТЕСТЫ (Tests)
│   │
│   ├─→ Содержит ВОПРОСЫ (Questions)
│   │   │
│   │   └─→ Содержит ОТВЕТЫ (Answers)
│   │
│   └─→ Используется в ИГРОВЫХ СЕССИЯХ
│       │
│       ├─→ Содержит ИГРОКОВ (GamePlayers)
│       │   │
│       │   └─→ Дают ОТВЕТЫ (PlayerAnswers)
│       │
│       └─→ Обновляет СТАТИСТИКУ (UserStatistics)

СВЯЗИ:
Users.id ──┐
           ├→ Tests.creator_id (1:N)
           │
           ├→ GamePlayers.user_id (1:N)
           │
           └→ UserStatistics.user_id (1:1)

Tests.id ──┐
           ├→ Questions.test_id (1:N)
           │
           └→ GameSessions.test_id (1:N)

Questions.id ───→ Answers.question_id (1:N)

GameSessions.id ────┐
                    ├→ GamePlayers.game_session_id (1:N)
                    │
                    └→ PlayerAnswers.game_session_id (1:N)

GamePlayers.id ─────→ PlayerAnswers.game_player_id (1:N)

Answers.id ──────────→ PlayerAnswers.answer_id (N:1)
```

---

## 🔐 Поток аутентификации

```
РЕГИСТРАЦИЯ
═══════════════════════════════════════
┌─ Пользователь заполняет форму регистрации
│  ├─ username: "john_doe"
│  ├─ email: "john@example.com"
│  ├─ password: "secret123"
│  └─ password_confirm: "secret123"
│
└─ POST /api.php?action=register
   │
   ├─ Валидировать данные (проверить длину, формат)
   │
   ├─ Проверить, нет ли дубликатов (username, email)
   │
   ├─ Хешировать пароль (Bcrypt)
   │  password_hash = "$2y$10$...abcdef..."
   │
   ├─ INSERT в bisai_users
   │  ├─ username, email, password_hash ✅
   │  └─ role = 'user', is_active = true
   │
   ├─ INSERT в bisai_user_statistics
   │
   └─ Редирект на login.php ✅


ВХОД
═════════════════════════════════════════
┌─ Пользователь вводит логин и пароль
│  ├─ username: "john_doe"
│  └─ password: "secret123"
│
└─ POST /api.php?action=login
   │
   ├─ Найти пользователя по username
   │  SELECT * FROM bisai_users WHERE username = "john_doe"
   │  ✅ Найден
   │
   ├─ Проверить пароль
   │  password_verify("secret123", "$2y$10$...abcdef...")
   │  ✅ Верный пароль
   │
   ├─ Установить сессию
   │  $_SESSION['user_id'] = 1
   │
   ├─ Обновить last_login
   │  UPDATE bisai_users SET last_login = NOW()
   │
   └─ Редирект на /dashboard.php ✅


АВТОРИЗОВАННЫЙ ЗАПРОС
═════════════════════════════════════════
┌─ Пользователь делает запрос
│
├─ Сервер проверяет $_SESSION['user_id']
│
├─ Если существует → User::find($_SESSION['user_id'])
│  └─ Получить данные пользователя
│
├─ Разрешить доступ к защищенному ресурсу ✅
│
└─ Если не существует → Редирект на /login.php ❌


ВЫХОД
═════════════════════════════════════════
┌─ Пользователь кликает "Выход"
│
├─ GET /logout.php
│
├─ session_destroy()
│  └─ Удалить все данные сессии
│
└─ Редирект на /index.php ✅
```

---

## 🎨 Поток отображения страницы

```
1. ЗАПРОС БРАУЗЕРА
   GET /public/index.php
   │
2. ЗАГРУЗКА ФАЙЛА
   ├─ Загрузить index.php в память
   │
3. ИНИЦИАЛИЗАЦИЯ
   ├─ require_once '../includes/autoload.php'
   │  ├─ Подключить constants.php
   │  ├─ Подключить Database.php
   │  ├─ Зарегистрировать автозагрузчик классов
   │  └─ Стартовать сессию
   │
4. ПОЛУЧЕНИЕ ДАННЫХ
   ├─ $user = getAuthUser()
   │  └─ Если $_SESSION['user_id'] → Load User Model
   │
   ├─ $publicTests = Test::getPublished()
   │  └─ SELECT * FROM bisai_tests WHERE status='published' AND is_public=1
   │
5. ОБРАБОТКА (КОНТРОЛЛЕР)
   ├─ Обработать GET параметры
   ├─ Обработать POST запросы (если есть)
   ├─ Подготовить переменные для view
   │
6. РЕНДЕРИНГ (VIEW)
   ├─ Начать HTML документ
   ├─ Вывести заголовок (header)
   ├─ Вывести основной контент
   │  ├─ Вывести список тестов
   │  ├─ Для каждого теста:
   │  │  ├─ Название
   │  │  ├─ Описание
   │  │  ├─ Уровень сложности
   │  │  ├─ Количество вопросов
   │  │  └─ Кнопка "Играть"
   │  │
   ├─ Подключить CSS файлы
   │  └─ /assets/css/main.css
   │
   ├─ Подключить JS файлы
   │  └─ /assets/js/main.js
   │
   ├─ Вывести подвал (footer)
   └─ Закрыть HTML документ
   │
7. ОТПРАВКА ОТВЕТА
   ├─ Установить заголовки (Content-Type, Cache-Control)
   ├─ Отправить HTML браузеру
   │
8. БРАУЗЕР ОБРАБАТЫВАЕТ
   ├─ Парсировать HTML
   ├─ Загрузить CSS (style)
   ├─ Загрузить JS (script)
   ├─ Выполнить JS код
   ├─ Отобразить страницу (rendering)
   └─ Ждет взаимодействия пользователя

ГОТОВО! ✅ Страница загружена и интерактивна
```

---

## 📱 Мобильная адаптивность

```
DESKTOP (1200px+)
┌─────────────────────────────────────┐
│        HEADER (Fixed Top)           │
│  Logo    |    Menu    |    Profile  │
├─────────────────────────────────────┤
│                                     │
│  ┌───────────────┐ ┌───────────────┐│
│  │  Test Card 1  │ │  Test Card 2  ││
│  └───────────────┘ └───────────────┘│
│  ┌───────────────┐ ┌───────────────┐│
│  │  Test Card 3  │ │  Test Card 4  ││
│  └───────────────┘ └───────────────┘│
│                                     │
├─────────────────────────────────────┤
│        FOOTER                       │
└─────────────────────────────────────┘

TABLET (768px - 1199px)
┌──────────────────────────┐
│        HEADER            │
├──────────────────────────┤
│                          │
│  ┌──────────┐ ┌────────┐│
│  │   Test1  │ │ Test2  ││
│  └──────────┘ └────────┘│
│  ┌──────────┐ ┌────────┐│
│  │   Test3  │ │ Test4  ││
│  └──────────┘ └────────┘│
│                          │
├──────────────────────────┤
│      FOOTER              │
└──────────────────────────┘

MOBILE (< 768px)
┌─────────────────┐
│     HEADER      │
├─────────────────┤
│                 │
│  ┌───────────┐  │
│  │  Test 1   │  │
│  └───────────┘  │
│  ┌───────────┐  │
│  │  Test 2   │  │
│  └───────────┘  │
│  ┌───────────┐  │
│  │  Test 3   │  │
│  └───────────┘  │
│                 │
├─────────────────┤
│      FOOTER     │
└─────────────────┘
```

---

## 🔧 Технологический стек

```
┌─ FRONTEND ────────────────────────┐
│ • HTML5 - структура               │
│ • CSS3 - стилизация и адаптивность│
│ • JavaScript (ES6) - интерактивность
│ • Canvas API - анимация каната    │
│ • Web Audio API - фоновая музыка  │
│ • Fetch API - AJAX запросы        │
└───────────────────────────────────┘

┌─ BACKEND ─────────────────────────┐
│ • PHP 7.4+ - серверная логика    │
│ • OOP - объектно-ориентированное  │
│ • MVC - архитектурный паттерн     │
│ • PDO - безопасная работа с БД    │
│ • Bcrypt - хеширование паролей   │
└───────────────────────────────────┘

┌─ DATABASE ────────────────────────┐
│ • MySQL 5.7+ или MariaDB 10.2+   │
│ • 9 таблиц (нормализованная БД)  │
│ • Индексы для оптимизации         │
│ • Foreign Keys для целостности    │
│ • UTF8MB4 кодировка               │
└───────────────────────────────────┘

┌─ ИНСТРУМЕНТЫ ─────────────────────┐
│ • Git - система контроля версий   │
│ • phpMyAdmin - управление БД      │
│ • Apache/Nginx - веб-сервер       │
│ • Composer - менеджер зависимостей│
└───────────────────────────────────┘
```

---

## ✅ Список всех созданных файлов

### /config
- ✅ db.php (параметры БД)
- ✅ app.php (конфигурация приложения)
- ✅ constants.php (глобальные константы)

### /database
- ✅ migrations/001_create_initial_tables.sql (создание таблиц)

### /includes
- ✅ Database.php (Singleton для БД)
- ✅ autoload.php (автозагрузка классов)
- ✅ functions.php (вспомогательные функции)
- ✅ auth.php (функции авторизации)

### /models
- ✅ BaseModel.php (базовый класс)
- ✅ User.php (пользователи)
- ✅ Test.php (тесты)
- ✅ Question.php (вопросы и ответы)
- ✅ GameSession.php (игровые сессии)

### /controllers
- ✅ BaseController.php (базовый контроллер)
- ✅ AuthController.php (авторизация)
- ✅ TestController.php (управление тестами)
- ✅ GameController.php (игровая логика)

### /public
- ✅ api.php (API точка входа)
- ✅ index.php (главная страница)
- ✅ login.php (форма входа)
- ✅ logout.php (выход)
- ✅ play.php (игровой интерфейс)

### /public/assets
- ✅ css/main.css (основные стили)
- ✅ js/main.js (основной JavaScript)
- ✅ js/game.js (логика игры)
- ✅ js/tug-of-war.js (анимация каната)

### Документация
- ✅ README.md (основная документация)
- ✅ INSTALL.md (инструкция по установке)
- ✅ PROJECT_STRUCTURE.md (структура проекта)
- ✅ ARCHITECTURE.md (техническая документация)

**ИТОГО: 35+ файлов, полностью готовая архитектура! ✅**

---

## 🚀 Следующие шаги

1. **Установка БД** → Выполнить SQL скрипт из `database/migrations/`
2. **Конфигурация** → Отредактировать `config/db.php`
3. **Тестирование** → Запустить локальный сервер
4. **Развертывание** → Загрузить на хостинг

---

**Проект готов к использованию!** 🎉

*Последнее обновление: 10.12.2025*
